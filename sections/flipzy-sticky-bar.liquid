{%- liquid
  assign placeholder = false
  if section.blocks.size == 0
    assign placeholder = true
  endif
-%}

<script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

{%- style -%}
  /* --- STICKY BAR CSS --- */
  .flipzy-sticky {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #ffffff;
    border-top: 1px solid #e5e7eb;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
    /* FIXED Z-INDEX: Lowered from max (2147483647) to 1999999 
       to sit below Shopify's cookie banner (z-index 2000000) 
    */
    z-index: 1999999 !important; 
    padding: 10px 0;
    transform: translateY(110%);
    transition: transform 0.3s ease-in-out;
    display: block !important;
  }

  .flipzy-sticky.is-visible {
    transform: translateY(0);
  }

  /* --- FLIPZY EXTRA: Force hide when drawer is open --- */
  .flipzy-sticky.is-hidden-by-drawer {
    display: none !important;
    transform: translateY(110%) !important;
    pointer-events: none !important;
  }
  /* ---------------------------------------------------- */

  .flipzy-sticky-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* Left Side: Text */
  .flipzy-sticky-info {
    display: flex;
    flex-direction: column;
  }
  .flipzy-sticky-title {
    font-size: 1rem;
    font-weight: 700;
    margin: 0;
    line-height: 1.2;
    color: #111;
  }
  .flipzy-sticky-sub {
    font-size: 0.8rem;
    color: #059669; /* Green */
    font-weight: 600;
  }

  /* Center: Quantity Selector */
  .flipzy-quantity-selector {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .flipzy-quantity-select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background-color: #f9fafb;
    font-size: 1rem;
    font-weight: 600;
    color: #111;
    cursor: pointer;
    min-width: 70px;
  }

  /* Right Side: Price + Button (Desktop Layout) */
  .flipzy-sticky-action {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .flipzy-sticky-price-box {
    text-align: right;
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1;
  }
  
  .flipzy-sticky-old {
    text-decoration: line-through;
    color: #9ca3af;
    font-size: 0.9rem;
    margin-bottom: 2px;
  }
  
  .flipzy-sticky-new {
    font-weight: 800;
    font-size: 1.6rem;
    color: #111;
  }

  .flipzy-sticky-btn {
    background-color: #F4D35E;
    color: #111827;
    border: none;
    border-radius: 50px;
    font-weight: 700;
    font-size: 1rem;
    padding: 12px 24px;
    cursor: pointer;
    white-space: nowrap;
    transition: transform 0.2s;
    box-shadow: 0 4px 10px rgba(244, 211, 94, 0.3);
  }
  .flipzy-sticky-btn:hover {
    transform: scale(1.02);
  }

  /* --- MOBILE LAYOUT FIXES --- */
  @media (max-width: 768px) {
    .flipzy-sticky {
      padding: 8px 0;
    }

    .flipzy-sticky-inner {
      padding: 0 12px;
      gap: 10px;
      align-items: center; 
    }
    
    .flipzy-sticky-info { display: none; }

    /* Center: Quantity takes available space on left */
    .flipzy-quantity-selector {
      flex: 1;
      margin-right: 5px;
    }

    /* Action Area: Stacked Vertically */
    .flipzy-sticky-action { 
      flex-direction: column;
      align-items: flex-end; 
      gap: 4px;
      min-width: 110px;
    }

    /* Price Row: Side by side to save height */
    .flipzy-sticky-price-box {
      flex-direction: row;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 2px;
    }

    .flipzy-sticky-new { font-size: 1.1rem; }
    .flipzy-sticky-old { font-size: 0.8rem; }

    /* Button: Full width of the action container */
    .flipzy-sticky-btn {
      width: 100%;
      padding: 8px 12px;
      font-size: 0.9rem;
      border-radius: 6px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .flipzy-quantity-select {
        height: 36px;
        padding: 5px 10px;
    }
  }
{%- endstyle -%}

{% unless placeholder %}
  {% comment %} 
    We only check the FIRST block for the product to display. 
    The logic simplifies to 1 product -> Quantity Selector.
  {% endcomment %}
  
  {% assign target_block = section.blocks.first %}
  {% assign prod = target_block.settings.product %}
  
  {% if prod != blank %}
    {% assign variant = prod.selected_or_first_available_variant %}
    
    <div id="flipzy-sticky-bar-{{ section.id }}" class="flipzy-sticky">
      <div class="flipzy-sticky-inner">
        
        <div class="flipzy-sticky-info">
          <p class="flipzy-sticky-title">{{ section.settings.text }}</p>
          {% if section.settings.subline_text != blank %}
            <div class="flipzy-sticky-sub">{{ section.settings.subline_text }}</div>
          {% endif %}
        </div>
  
        <div class="flipzy-quantity-selector">
            <span style="font-weight: 600; font-size: 0.9rem; color: #374151;">Quantity:</span>
            <select id="stick-quantity-selector" class="flipzy-quantity-select" onchange="updateStickyPrice(this)">
                <!-- Options populated by JS for dynamic price, but we keep hardcoded fallbacks for SEO/No-JS -->
                <option value="1">1x Flipzy</option>
                <option value="2">2x Flipzys (‚≠ê Popular + Free Shipping)</option>
                <option value="3">3x Flipzys (3 for 2 Deal)</option>
                <option value="4">4x Flipzys (üî• Best Value)</option>
            </select>
        </div>
  
        <div class="flipzy-sticky-action">
          <div class="flipzy-sticky-price-box">
             <!-- Price updated by JS -->
            <span class="flipzy-sticky-new" id="sticky-price-new">{{ variant.price | money }}</span>
          </div>
  
          <button type="button" class="flipzy-sticky-btn" onclick="submitStickyForm()">
            {{ section.settings.button_label }}
          </button>
        </div>
  
      </div>
    </div>
  
    <div style="display:none;">
          {% assign unique_id = 'sticky-product-info-' | append: target_block.id %}
          {% assign product_form_id = 'product-form-' | append: unique_id %}
          
          <product-info
            id="{{ unique_id }}"
            data-section="{{ section.id }}"
            data-product-id="{{ prod.id }}"
            data-update-url="false"
            data-url="{{ prod.url }}"
          >
            {%- render 'buy-buttons', 
                block: target_block, 
                product: prod, 
                product_form_id: product_form_id, 
                section_id: section.id, 
                show_dynamic_checkout: false 
            -%}
            
            <button id="real-submit-sticky" type="submit" form="{{ product_form_id }}">Submit</button>
          </product-info>
    </div>
  {% endif %}

{% endunless %}

<script>
  // Hardcoded Config to Match Main Offer
  window.stickyConfig = {
    basePrice: {{ variant.price | default: prod.price | default: 0 | json }},
    moneyFormat: {{ shop.money_format | json }},
    tiers: {
      1: { discount: 0, label: "1x Flipzy" },
      2: { discount: 7.4, label: "2x Flipzys (‚≠ê Popular + Free Shipping)" },
      3: { discount: 20, label: "3x Flipzys (3 for 2 Deal - 20% OFF)" },
      4: { discount: 25, label: "4x Flipzys (üî• Best Value - 25% OFF)" }
    }
  };

  // Mirrored Format Money Logic
  function formatStickyMoney(cents) {
    const currencyCode = {{ cart.currency.iso_code | json }};
    const moneyFormat = window.stickyConfig.moneyFormat;
    
    if (!moneyFormat) return (cents / 100).toFixed(2) + ' ' + currencyCode;

    let value = (cents / 100).toFixed(2);
    let valueWithComma = value.replace('.', ',');
    let formatted = moneyFormat;

    if (formatted.includes('{' + '{amount_with_comma_separator}'+'}')) {
        formatted = formatted.replace('{' + '{amount_with_comma_separator}'+'}', valueWithComma);
    } else if (formatted.includes('{' + '{amount}'+'}')) {
        formatted = formatted.replace('{' + '{amount}'+'}', value);
    } else {
        formatted = formatted.replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g, valueWithComma)
                             .replace(/\{\{\s*amount\s*\}\}/g, value);
    }
    
    if (formatted.indexOf('{' + '{') !== -1) {
         return value + ' ' + currencyCode;
    }

    return formatted;
  }

  function updateStickyPrice(select) {
    const qty = parseInt(select.value);
    
    // 1. Calculate Price
    const basePrice = window.stickyConfig.basePrice;
    const tier = window.stickyConfig.tiers[qty] || { discount: 0 };
    const discountPct = tier.discount;
    
    const baseTotal = basePrice * qty;
    const rawPrice = baseTotal * (1 - (discountPct / 100));
    
    // 2. Rounding Logic (Math.ceil)
    const finalPrice = Math.ceil(rawPrice / 100) * 100;
    
    // 3. Update Text
    document.getElementById('sticky-price-new').innerText = formatStickyMoney(finalPrice);
  }

  function submitStickyForm() {
    const qty = document.getElementById('stick-quantity-selector').value;
    const btn = document.getElementById('real-submit-sticky');
    
    if(btn) {
        const formId = btn.getAttribute('form');
        const form = document.getElementById(formId);
        
        if(form) {
            let qtyInput = form.querySelector('input[name="quantity"]');
            if(!qtyInput) {
                qtyInput = document.createElement('input');
                qtyInput.type = 'hidden';
                qtyInput.name = 'quantity';
                form.appendChild(qtyInput);
            }
            qtyInput.value = qty;
            btn.click();
        }
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const bar = document.getElementById('flipzy-sticky-bar-{{ section.id }}');
    if(!bar) return;
    
    // Initialize correct price for default selection (1)
    const selector = document.getElementById('stick-quantity-selector');
    if(selector) updateStickyPrice(selector);

    // SCROLL LOGIC
    let lastScrollY = window.scrollY;
    let direction = 'down'; 
    let reversals = 0;
    
    const REVERSAL_THRESHOLD = 3; 
    
    function checkScroll() {
      const currentScrollY = window.scrollY;
      const scrollDiff = currentScrollY - lastScrollY;
      
      if (Math.abs(scrollDiff) > 10) {
          const newDirection = scrollDiff > 0 ? 'down' : 'up';
          if (newDirection !== direction) {
              reversals++;
              direction = newDirection;
          }
      }

      const heroSection = document.querySelector('.section-hero') || document.querySelector('.flipzy-hero-container');
      let triggerPoint = window.innerHeight; 
      if (heroSection) {
          triggerPoint = heroSection.getBoundingClientRect().height + 100;
      }

      const isDeepEnough = currentScrollY > triggerPoint;
      const isLost = reversals >= REVERSAL_THRESHOLD;
      
      if (isDeepEnough && isLost) {
          bar.classList.add('is-visible');
      } else {
         if(currentScrollY < 100) {
            bar.classList.remove('is-visible');
            reversals = 0; 
         }
      }
      
      lastScrollY = currentScrollY;
    }
    
    window.addEventListener('scroll', checkScroll, { passive: true });
    checkScroll();
  });
</script>

{% schema %}
{
  "name": "Flipzy Sticky Bar",
  "settings": [
    { 
      "type": "text", 
      "id": "text", 
      "label": "Headline (Desktop Only)", 
      "default": "Kids Routine Board" 
    },
    { 
      "type": "text", 
      "id": "subline_text", 
      "label": "Subline (Desktop Only)", 
      "default": "Special Offer Ends Soon" 
    },
    { 
      "type": "text", 
      "id": "button_label", 
      "label": "Button Label", 
      "default": "Add to Cart" 
    },
    {
      "type": "range",
      "id": "default_selected",
      "min": 1,
      "max": 4,
      "step": 1,
      "label": "Default Selected Option",
      "default": 1,
      "info": "Which block index is selected by default? 1 = Lowest price entry."
    }
  ],
  "blocks": [
    {
      "type": "bundle",
      "name": "Bundle Option",
      "limit": 4,
      "settings": [
        { "type": "product", "id": "product", "label": "Product Bundle" },
        { "type": "text", "id": "short_name", "label": "Short Label", "default": "1x", "info": "e.g. '1x' or '2 Pack'" },
        { "type": "text", "id": "badge_text", "label": "Badge Label", "default": "Best Value", "info": "e.g. '3 for 2' or 'Most Popular'. Short text works best." },
        { "type": "checkbox", "id": "show_free_shipping", "label": "Show Free Shipping Badge", "default": false }
      ]
    }
  ],
  "presets": [ 
    { 
      "name": "Flipzy Sticky Bar",
      "blocks": [
        { "type": "bundle", "settings": { "short_name": "1x", "badge_text": "Single" } },
        { "type": "bundle", "settings": { "short_name": "2x", "badge_text": "Most Popular", "show_free_shipping": true } },
        { "type": "bundle", "settings": { "short_name": "3x", "badge_text": "3 for 2", "show_free_shipping": true } }
      ]
    } 
  ]
}
{% endschema %}