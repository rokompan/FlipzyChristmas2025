{% schema %}
{
  "name": "Flipzy Sticky Bar",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "text",
      "id": "text",
      "label": "Headline Text",
      "default": "Kids Routine Board That Works"
    },
    {
      "type": "text",
      "id": "subline_text",
      "label": "Subline Text",
      "default": "Special offer available while supplies last"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "Add to Cart"
    }
  ],
  "presets": [
    {
      "name": "Flipzy Sticky Bar"
    }
  ]
}
{% endschema %}

{%- liquid
  assign product = section.settings.product
  assign variant = product.selected_or_first_available_variant
  assign compare_price = variant.compare_at_price
  assign price = variant.price
-%}

<div id="flipzy-sticky-bar" class="flipzy-sticky">
  <div class="flipzy-sticky__inner">
    
    <div class="flipzy-sticky__info">
      <p class="flipzy-sticky__title">
        {% if section.settings.text != blank %}
          {{ section.settings.text }}
        {% else %}
          {{ product.title }}
        {% endif %}
      </p>
      
      <div class="flipzy-sticky__sub">
        <div class="flipzy-sticky__price-box">
          {% if compare_price > price %}
            <span class="flipzy-sticky-old">{{ compare_price | money }}</span>
          {% endif %}
          <span class="flipzy-sticky-new">{{ price | money }}</span>
        </div>
        <span style="opacity: 0.5;">|</span>
        <span>{{ section.settings.subline_text }}</span>
      </div>
    </div>

    <div class="flipzy-sticky__cta">
      {% if product != blank %}
        <button 
          type="button" 
          class="flipzy-sticky__btn"
          onclick="addStickyToCart(this, '{{ variant.id }}')"
          {% unless variant.available %}disabled style="opacity: 0.6;"{% endunless %}
        >
          <span class="btn-text">
            {% if variant.available %}
              {{ section.settings.button_label }}
            {% else %}
              Sold Out
            {% endif %}
          </span>
          <div class="loading-overlay__spinner hidden" style="width:20px; height:20px;">
            <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg"><circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30" stroke="currentColor"></circle></svg>
          </div>
        </button>
      {% else %}
        <button class="flipzy-sticky__btn" disabled>Select Product</button>
      {% endif %}
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const bar = document.getElementById('flipzy-sticky-bar');
  // Iščemo Hero sekcijo, da vemo kdaj pokazati bar
  const hero = document.querySelector('.flipzy-hero-container'); 

  function checkScroll() {
    if (!hero) {
       // Če heroja ni, pokaži takoj po 200px
       if(window.scrollY > 200) bar.classList.add('is-visible');
       else bar.classList.remove('is-visible');
       return;
    }
    
    const heroBottom = hero.getBoundingClientRect().bottom;
    
    // Ko gre dno heroja izven ekrana (negativna vrednost), pokaži bar
    if (heroBottom < 0) {
      bar.classList.add('is-visible');
    } else {
      bar.classList.remove('is-visible');
    }
  }

  window.addEventListener('scroll', checkScroll, { passive: true });
  checkScroll(); // Check on load
});

// --- ADD TO CART LOGIC (Ista kot pri Super Product) ---
function addStickyToCart(btn, variantId) {
    if(!variantId) return;
    
    const spinner = btn.querySelector('.loading-overlay__spinner');
    const text = btn.querySelector('.btn-text');
    if(spinner) spinner.classList.remove('hidden');
    if(text) text.style.display = 'none';
    
    let rootUrl = window.Shopify.routes.root;
    if (rootUrl.endsWith('/')) rootUrl = rootUrl.slice(0, -1);
    
    const addUrl = rootUrl + '/cart/add.js';
    const sectionUrl = rootUrl + '/?sections=cart-drawer,cart-icon-bubble';

    fetch(addUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ items: [{ id: variantId, quantity: 1 }] })
    })
    .then(r => r.json())
    .then(d => {
      // Fetch Drawer HTML
      const cartDrawer = document.querySelector('cart-drawer');
      fetch(sectionUrl)
        .then(res => res.json())
        .then(sections => {
           // Update Bubble
           const bubble = document.getElementById('cart-icon-bubble');
           if(bubble && sections['cart-icon-bubble']) bubble.innerHTML = sections['cart-icon-bubble'];

           // Open Drawer
           if (cartDrawer && sections['cart-drawer']) {
               cartDrawer.renderContents(sections['cart-drawer']);
               setTimeout(() => cartDrawer.open(), 100);
           } else {
               window.location.href = rootUrl + '/cart';
           }
        });
    })
    .catch(e => {
       console.error(e);
       window.location.href = rootUrl + '/cart';
    })
    .finally(() => {
       setTimeout(() => {
         if(spinner) spinner.classList.add('hidden');
         if(text) text.style.display = 'block';
       }, 1000);
    });
}
</script>