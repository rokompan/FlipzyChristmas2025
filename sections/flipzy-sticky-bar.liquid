{%- liquid
  assign placeholder = false
  if section.blocks.size == 0
    assign placeholder = true
  endif
-%}

<script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

{%- style -%}
  /* --- STICKY BAR CSS --- */
  .flipzy-sticky {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #ffffff;
    border-top: 1px solid #e5e7eb;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
    /* FIXED Z-INDEX: Lowered from max (2147483647) to 1999999 
       to sit below Shopify's cookie banner (z-index 2000000) 
    */
    z-index: 1999999 !important; 
    padding: 10px 0;
    transform: translateY(110%);
    transition: transform 0.3s ease-in-out;
    display: block !important;
  }

  .flipzy-sticky.is-visible {
    transform: translateY(0);
  }

  /* --- FLIPZY EXTRA: Force hide when drawer is open --- */
  .flipzy-sticky.is-hidden-by-drawer {
    display: none !important;
    transform: translateY(110%) !important;
    pointer-events: none !important;
  }
  /* ---------------------------------------------------- */

  .flipzy-sticky-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* Left Side: Text */
  .flipzy-sticky-info {
    display: flex;
    flex-direction: column;
  }
  .flipzy-sticky-title {
    font-size: 1rem;
    font-weight: 700;
    margin: 0;
    line-height: 1.2;
    color: #111;
  }
  .flipzy-sticky-sub {
    font-size: 0.8rem;
    color: #059669; /* Green */
    font-weight: 600;
  }

  /* Center: Quantity Selector */
  .flipzy-quantity-selector {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .flipzy-quantity-select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background-color: #f9fafb;
    font-size: 1rem;
    font-weight: 600;
    color: #111;
    cursor: pointer;
    min-width: 70px;
  }

  /* Right Side: Price + Button (Desktop Layout) */
  .flipzy-sticky-action {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .flipzy-sticky-price-box {
    text-align: right;
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1;
  }
  
  .flipzy-sticky-old {
    text-decoration: line-through;
    color: #9ca3af;
    font-size: 0.9rem;
    margin-bottom: 2px;
  }
  
  .flipzy-sticky-new {
    font-weight: 800;
    font-size: 1.6rem;
    color: #111;
  }

  .flipzy-sticky-btn {
    background-color: #F4D35E;
    color: #111827;
    border: none;
    border-radius: 50px;
    font-weight: 700;
    font-size: 1rem;
    padding: 12px 24px;
    cursor: pointer;
    white-space: nowrap;
    transition: transform 0.2s;
    box-shadow: 0 4px 10px rgba(244, 211, 94, 0.3);
  }
  .flipzy-sticky-btn:hover {
    transform: scale(1.02);
  }

  /* --- MOBILE LAYOUT FIXES --- */
  @media (max-width: 768px) {
    .flipzy-sticky {
      padding: 8px 0;
    }

    .flipzy-sticky-inner {
      padding: 0 12px;
      gap: 10px;
      align-items: center; 
    }
    
    .flipzy-sticky-info { display: none; }

    /* Center: Quantity takes available space on left */
    .flipzy-quantity-selector {
      flex: 1;
      margin-right: 5px;
    }

    /* Action Area: Stacked Vertically */
    .flipzy-sticky-action { 
      flex-direction: column;
      align-items: flex-end; 
      gap: 4px;
      min-width: 110px;
    }

    /* Price Row: Side by side to save height */
    .flipzy-sticky-price-box {
      flex-direction: row;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 2px;
    }

    .flipzy-sticky-new { font-size: 1.1rem; }
    .flipzy-sticky-old { font-size: 0.8rem; }

    /* Button: Full width of the action container */
    .flipzy-sticky-btn {
      width: 100%;
      padding: 8px 12px;
      font-size: 0.9rem;
      border-radius: 6px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .flipzy-quantity-select {
        height: 36px;
        padding: 5px 10px;
    }
  }
{%- endstyle -%}

{% unless placeholder %}
  {% comment %} 
    We only check the FIRST block for the product to display. 
    The logic simplifies to 1 product -> Quantity Selector.
  {% endcomment %}
  
  {% assign target_block = section.blocks.first %}
  {% assign prod = target_block.settings.product %}
  
  {% if prod != blank %}
    {% assign variant = prod.selected_or_first_available_variant %}
    
    <div id="flipzy-sticky-bar-{{ section.id }}" class="flipzy-sticky">
      <div class="flipzy-sticky-inner">
        
        <div class="flipzy-sticky-info">
          <p class="flipzy-sticky-title">{{ section.settings.text }}</p>
          {% if section.settings.subline_text != blank %}
            <div class="flipzy-sticky-sub">{{ section.settings.subline_text }}</div>
          {% endif %}
        </div>
  
        <div class="flipzy-quantity-selector">
            <span style="font-weight: 600; font-size: 0.9rem; color: #374151;">Quantity:</span>
            <select id="stick-quantity-selector" class="flipzy-quantity-select" onchange="updateStickyPrice(this)">
                <option value="1" data-price="{{ variant.price | money }}">1 Pair - {{ variant.price | money }}</option>
                <option value="2" data-price="{{ variant.price | times: 2 | money }}">2 Pairs - {{ variant.price | times: 2 | money }} + Free Shipping</option>
                {% comment %} Note: "3 for 2" implies paying for 2. We show the raw price calculation as requested "price - 3 for 2" unless discount is manual. {% endcomment %}
                <option value="3" data-price="{{ variant.price | times: 3 | money }}">3 Pairs - {{ variant.price | times: 3 | money }} (3 for 2 Deal)</option>
                <option value="4" data-price="{{ variant.price | times: 4 | money }}">4 Pairs - {{ variant.price | times: 4 | money }} (Save 30%)</option>
            </select>
        </div>
  
        <div class="flipzy-sticky-action">
          <div class="flipzy-sticky-price-box">
            <span class="flipzy-sticky-old" id="sticky-price-old" style="{% unless variant.compare_at_price > variant.price %}display:none;{% endunless %}">
                {{ variant.compare_at_price | money }}
            </span>
            <span class="flipzy-sticky-new" id="sticky-price-new" data-base-price="{{ variant.price }}">{{ variant.price | money }}</span>
          </div>
  
          <button type="button" class="flipzy-sticky-btn" onclick="submitStickyForm()">
            {{ section.settings.button_label }}
          </button>
        </div>
  
      </div>
    </div>
  
    <div style="display:none;">
          {% assign unique_id = 'sticky-product-info-' | append: target_block.id %}
          {% assign product_form_id = 'product-form-' | append: unique_id %}
          
          <product-info
            id="{{ unique_id }}"
            data-section="{{ section.id }}"
            data-product-id="{{ prod.id }}"
            data-update-url="false"
            data-url="{{ prod.url }}"
          >
            {%- render 'buy-buttons', 
                block: target_block, 
                product: prod, 
                product_form_id: product_form_id, 
                section_id: section.id, 
                show_dynamic_checkout: false 
            -%}
            
            {% comment %} 
                We need to inject a quantity input into the form so it respects our selection.
                Typically 'buy-buttons' renders the form. We will manipulate it via JS before submit.
            {% endcomment %}
            <button id="real-submit-sticky" type="submit" form="{{ product_form_id }}">Submit</button>
          </product-info>
    </div>
  {% endif %}

{% endunless %}

<script>
  function updateStickyPrice(select) {
    const selectedOption = select.options[select.selectedIndex];
    const newPrice = selectedOption.getAttribute('data-price');
    if(newPrice) {
        document.getElementById('sticky-price-new').innerText = newPrice;
    }
  }

  function submitStickyForm() {
    const qty = document.getElementById('stick-quantity-selector').value;
    const btn = document.getElementById('real-submit-sticky');
    
    if(btn) {
        const formId = btn.getAttribute('form');
        const form = document.getElementById(formId);
        
        if(form) {
            // Check if input[name="quantity"] exists
            let qtyInput = form.querySelector('input[name="quantity"]');
            if(!qtyInput) {
                qtyInput = document.createElement('input');
                qtyInput.type = 'hidden';
                qtyInput.name = 'quantity';
                form.appendChild(qtyInput);
            }
            qtyInput.value = qty;
            
            // Trigger submit
            btn.click();
        } else {
            console.error("Flipzy Sticky: Form not found");
        }
    } else {
      console.error("Flipzy Sticky: Could not find hidden submit button");
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const bar = document.getElementById('flipzy-sticky-bar-{{ section.id }}');
    if(!bar) return;

    // SCROLL LOGIC: "Lost User" Detection
    // Sticky appears only after user has scrolled up and down a bit (indecisive/browsing).
    
    let lastScrollY = window.scrollY;
    let direction = 'down'; 
    let reversals = 0;
    
    // Constants
    const REVERSAL_THRESHOLD = 3; // Number of direction changes before showing
    const MIN_SCROLL_DEPTH = 800; // Must scroll at least this deep to qualify
    
    function checkScroll() {
      const currentScrollY = window.scrollY;
      const scrollDiff = currentScrollY - lastScrollY;
      
      // 1. Determine Direction
      // Ignore tiny scrolls (jitter)
      if (Math.abs(scrollDiff) > 10) {
          const newDirection = scrollDiff > 0 ? 'down' : 'up';
          
          if (newDirection !== direction) {
              reversals++;
              direction = newDirection;
              // console.log("Direction change:", direction, "Reversals:", reversals);
          }
      }

      // 2. Visibility Logic
      // - Must be past the Trigger Point (e.g. Hero Section)
      // - AND must have exhibited "lost" behavior (reversals)
      // OR standard fallback: significantly deep in the page?
      
      const heroSection = document.querySelector('.section-hero') || document.querySelector('.flipzy-hero-container');
      let triggerPoint = window.innerHeight; // Default 1 screen
      if (heroSection) {
          triggerPoint = heroSection.getBoundingClientRect().height + 100;
      }

      const isDeepEnough = currentScrollY > triggerPoint;
      const isLost = reversals >= REVERSAL_THRESHOLD;

      // Logic: Show if Deep Enough AND (Lost OR (Deep & Scrolling Up))
      // Simplified as requested: "appears after user seems to be a bit lost and went up and down"
      
      if (isDeepEnough && isLost) {
          bar.classList.add('is-visible');
      } else {
         // Keep visible if already visible? usually sticky bars stay once triggered?
         // User said "Sticky comes in too soon...".
         // Let's allow it to hide if they go back to the very top.
         if(currentScrollY < 100) {
            bar.classList.remove('is-visible');
            reversals = 0; // Reset logic if they return to top
         }
         // Otherwise, wait for trigger.
      }
      
      lastScrollY = currentScrollY;
    }
    
    window.addEventListener('scroll', checkScroll, { passive: true });
    checkScroll();
  });
</script>

{% schema %}
{
  "name": "Flipzy Sticky Bar",
  "settings": [
    { 
      "type": "text", 
      "id": "text", 
      "label": "Headline (Desktop Only)", 
      "default": "Kids Routine Board" 
    },
    { 
      "type": "text", 
      "id": "subline_text", 
      "label": "Subline (Desktop Only)", 
      "default": "Special Offer Ends Soon" 
    },
    { 
      "type": "text", 
      "id": "button_label", 
      "label": "Button Label", 
      "default": "Add to Cart" 
    },
    {
      "type": "range",
      "id": "default_selected",
      "min": 1,
      "max": 4,
      "step": 1,
      "label": "Default Selected Option",
      "default": 1,
      "info": "Which block index is selected by default? 1 = Lowest price entry."
    }
  ],
  "blocks": [
    {
      "type": "bundle",
      "name": "Bundle Option",
      "limit": 4,
      "settings": [
        { "type": "product", "id": "product", "label": "Product Bundle" },
        { "type": "text", "id": "short_name", "label": "Short Label", "default": "1x", "info": "e.g. '1x' or '2 Pack'" },
        { "type": "text", "id": "badge_text", "label": "Badge Label", "default": "Best Value", "info": "e.g. '3 for 2' or 'Most Popular'. Short text works best." },
        { "type": "checkbox", "id": "show_free_shipping", "label": "Show Free Shipping Badge", "default": false }
      ]
    }
  ],
  "presets": [ 
    { 
      "name": "Flipzy Sticky Bar",
      "blocks": [
        { "type": "bundle", "settings": { "short_name": "1x", "badge_text": "Single" } },
        { "type": "bundle", "settings": { "short_name": "2x", "badge_text": "Most Popular", "show_free_shipping": true } },
        { "type": "bundle", "settings": { "short_name": "3x", "badge_text": "3 for 2", "show_free_shipping": true } }
      ]
    } 
  ]
}
{% endschema %}