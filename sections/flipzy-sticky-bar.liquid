{%- liquid
  assign product = section.settings.product
  if product == null
    assign placeholder = true
  endif
-%}

<script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

{%- style -%}
  /* CSS je v flipzy-custom.css */
{%- endstyle -%}

{% if product != blank %}
  {%- assign variant = product.selected_or_first_available_variant -%}
  {%- assign compare_price = variant.compare_at_price -%}
  {%- assign price = variant.price -%}
  {%- assign product_form_id = 'product-form-sticky-' | append: section.id -%}

  <div id="flipzy-sticky-bar-{{ section.id }}" class="flipzy-sticky">
    <div class="flipzy-sticky-inner">
      
      <div class="flipzy-sticky-info">
        <p class="flipzy-sticky-title">
          {% if section.settings.text != blank %}{{ section.settings.text }}{% else %}{{ product.title }}{% endif %}
        </p>
        {% if section.settings.subline_text != blank %}
          <div class="flipzy-sticky-sub">{{ section.settings.subline_text }}</div>
        {% endif %}
      </div>

      <div class="flipzy-sticky-price-box">
        {% if compare_price > price %}
          <span class="flipzy-sticky-old">{{ compare_price | money }}</span>
        {% endif %}
        <span class="flipzy-sticky-new">{{ price | money }}</span>
      </div>

      <div class="flipzy-sticky-action">
        <product-info
          id="ProductInfo-{{ section.id }}"
          data-section="{{ section.id }}"
          data-product-id="{{ product.id }}"
          data-update-url="false"
          data-url="{{ product.url }}"
        >
          {%- render 'buy-buttons',
            block: section, 
            product: product,
            product_form_id: product_form_id,
            section_id: section.id,
            show_dynamic_checkout: false
          -%}
        </product-info>
      </div>

    </div>
  </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const bar = document.getElementById('flipzy-sticky-bar-{{ section.id }}');
  const triggerSection = document.querySelector('.flipzy-hero-container') || document.querySelector('.section-featured-product');

  function checkScroll() {
    if (!triggerSection) {
       if(window.scrollY > 400) bar.classList.add('is-visible');
       else bar.classList.remove('is-visible');
       return;
    }
    const triggerBottom = triggerSection.getBoundingClientRect().bottom;
    if (triggerBottom < 0) { 
      bar.classList.add('is-visible');
    } else {
      bar.classList.remove('is-visible');
    }
  }
  window.addEventListener('scroll', checkScroll, { passive: true });
  checkScroll(); 
});
</script>

{% schema %}
{
  "name": "Flipzy Sticky Bar",
  "settings": [
    { "type": "product", "id": "product", "label": "Product" },
    { "type": "text", "id": "text", "label": "Headline", "default": "Kids Routine Board" },
    { "type": "text", "id": "subline_text", "label": "Subline", "default": "Special Offer" },
    { "type": "text", "id": "button_label", "label": "Button Label", "default": "Add to Cart" }
  ],
  "presets": [ { "name": "Flipzy Sticky Bar" } ]
}
{% endschema %}