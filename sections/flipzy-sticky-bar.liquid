{% schema %}
{
  "name": "Flipzy Sticky Bar",
  "settings": [
    { "type": "product", "id": "product", "label": "Product" },
    { "type": "text", "id": "text", "label": "Headline Text", "default": "Kids Routine Board" },
    { "type": "text", "id": "subline_text", "label": "Subline Text", "default": "Special offer available while supplies last" },
    { "type": "text", "id": "button_label", "label": "Button Label", "default": "Add to Cart" }
  ],
  "presets": [ { "name": "Flipzy Sticky Bar" } ]
}
{% endschema %}

{%- liquid
  assign product = section.settings.product
  assign variant = product.selected_or_first_available_variant
  assign compare_price = variant.compare_at_price
  assign price = variant.price
-%}

<div id="flipzy-sticky-bar" class="flipzy-sticky">
  <div class="flipzy-sticky__inner">
    
    <div class="flipzy-sticky__info">
      <p class="flipzy-sticky__title">
        {% if section.settings.text != blank %}
          {{ section.settings.text }}
        {% else %}
          {{ product.title }}
        {% endif %}
      </p>
      <div class="flipzy-sticky__sub">
        {% if compare_price > price %}
          <span class="flipzy-sticky-old">{{ compare_price | money }}</span>
        {% endif %}
        <span class="flipzy-sticky-new">{{ price | money }}</span>
        {% if section.settings.subline_text != blank %}
          <span style="opacity: 0.5; margin: 0 5px;">|</span>
          <span>{{ section.settings.subline_text }}</span>
        {% endif %}
      </div>
    </div>

    <div class="flipzy-sticky__cta">
      {% if product != blank %}
        <button 
          type="button" 
          class="product-form__submit button flipzy-sticky__btn"
          onclick="addStickyToCart(this, '{{ variant.id }}')"
          {% unless variant.available %}disabled style="opacity: 0.6;"{% endunless %}
        >
          <span class="btn-text">
            {% if variant.available %}
              {{ section.settings.button_label }}
            {% else %}
              Sold Out
            {% endif %}
          </span>
          <div class="loading-overlay__spinner hidden" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:24px; height:24px;">
            <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg"><circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30" stroke="currentColor"></circle></svg>
          </div>
        </button>
      {% else %}
        <button class="product-form__submit button flipzy-sticky__btn" disabled>Select Product</button>
      {% endif %}
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const bar = document.getElementById('flipzy-sticky-bar');
  // Poišči katerokoli "visoko" sekcijo, da vemo kdaj pokazati bar
  const triggerSection = document.querySelector('.flipzy-hero-container') || document.querySelector('.section-featured-product') || document.querySelector('.product-section');

  function checkScroll() {
    if (!triggerSection) {
       if(window.scrollY > 400) bar.classList.add('is-visible');
       else bar.classList.remove('is-visible');
       return;
    }
    const triggerBottom = triggerSection.getBoundingClientRect().bottom;
    if (triggerBottom < 0) {
      bar.classList.add('is-visible');
    } else {
      bar.classList.remove('is-visible');
    }
  }
  window.addEventListener('scroll', checkScroll, { passive: true });
  checkScroll(); 
});

// --- SAFE AJAX ADD TO CART (Same logic as Conversion Product) ---
function addStickyToCart(btn, variantId) {
    if(!variantId) return;
    
    const spinner = btn.querySelector('.loading-overlay__spinner');
    const text = btn.querySelector('.btn-text');
    if(spinner) spinner.classList.remove('hidden');
    if(text) text.style.opacity = '0';
    btn.setAttribute('disabled', true);
    
    // URL Logic
    let rootUrl = window.Shopify.routes.root;
    if (rootUrl.endsWith('/')) rootUrl = rootUrl.slice(0, -1);
    
    const addUrl = rootUrl + '/cart/add.js';
    const sectionUrl = rootUrl + '/?sections=cart-drawer,cart-icon-bubble';

    const formData = { items: [{ id: variantId, quantity: 1 }] };

    fetch(addUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(formData)
    })
    .then(r => r.json())
    .then(d => {
      const cartDrawer = document.querySelector('cart-drawer');
      const cartBubble = document.getElementById('cart-icon-bubble');

      fetch(sectionUrl)
        .then(res => res.json())
        .then(sections => {
           if(cartBubble && sections['cart-icon-bubble']) cartBubble.innerHTML = sections['cart-icon-bubble'];

           if (cartDrawer && sections['cart-drawer']) {
               cartDrawer.renderContents(sections['cart-drawer']);
               setTimeout(() => cartDrawer.open(), 100);
           } else {
               window.location.href = rootUrl + '/cart';
           }
        })
        .catch(() => { window.location.href = rootUrl + '/cart'; });
    })
    .catch(e => {
       console.error(e);
       window.location.href = rootUrl + '/cart';
    })
    .finally(() => {
       setTimeout(() => {
         if(spinner) spinner.classList.add('hidden');
         if(text) text.style.opacity = '1';
         btn.removeAttribute('disabled');
       }, 1000);
    });
}
</script>