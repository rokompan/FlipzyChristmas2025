<div id="flipzy-help-popup-root">
  <button type="button" class="flipzy-help-button" id="flipzy-help-open">
    {{ 'sections.flipzy_help.ask_question' | t }}
  </button>

  <div class="flipzy-help-overlay" id="flipzy-help-overlay" aria-hidden="true">
    <div class="flipzy-help-modal">
      <button type="button" class="flipzy-help-close" id="flipzy-help-close">&times;</button>
      <h2 class="flipzy-help-title">{{ 'sections.flipzy_help.title' | t }}</h2>
      <p class="flipzy-help-text">{{ 'sections.flipzy_help.text' | t }}</p>

      {% form 'contact', id: 'flipzy-help-form' %}
        <input type="hidden" name="form_type" value="contact">
        <input type="hidden" name="contact[email]" value="{{ shop.email | default: shop.customer_email }}">

        <label class="flipzy-help-label">
          {{ 'sections.flipzy_help.email_label' | t }}
          <input type="text" name="contact[reply_email]" placeholder="{{ 'sections.flipzy_help.email_placeholder' | t }}">
        </label>

        <label class="flipzy-help-label">
          {{ 'sections.flipzy_help.message_label' | t }}
          <textarea name="contact[body]" rows="4" required placeholder="{{ 'sections.flipzy_help.message_placeholder' | t }}"></textarea>
        </label>

        <button type="submit" class="flipzy-help-submit">{{ 'sections.flipzy_help.submit' | t }}</button>
      {% endform %}
    </div>
  </div>
</div>

<style>
  .flipzy-help-button{
    position:fixed;
    right:20px;
    bottom:90px; /* Malo višje, da je nad Sticky Barom */
    z-index:100;
    padding:10px 16px;
    border-radius:999px;
    border:none;
    background:#111827;
    color:#fff;
    font-size:14px;
    cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,.2);
    font-weight: 600;
    
    /* SKRITO PRIVZETO (Scroll Logic) */
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.4s;
  }

  /* Ko dodamo ta class z JS, se prikaže */
  .flipzy-help-button.is-visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .flipzy-help-button.is-visible:hover {
    transform: scale(1.05);
  }

  .flipzy-help-overlay{
    position:fixed;
    inset:0;
    z-index:99;
    background:rgba(15,23,42,.45);
    display:none;
    align-items:center;
    justify-content:center;
    backdrop-filter: blur(2px);
  }
  .flipzy-help-overlay.is-open{display:flex;}
  
  .flipzy-help-modal{
    width:100%;
    max-width:420px;
    background:#fff;
    border-radius:16px;
    padding:20px 20px 16px;
    box-shadow:0 18px 45px rgba(0,0,0,.25);
    position:relative;
    animation: flipzyFadeIn 0.3s ease-out;
  }
  @keyframes flipzyFadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .flipzy-help-close{
    position:absolute;
    top:8px;
    right:10px;
    border:none;
    background:transparent;
    font-size:24px;
    line-height: 1;
    cursor:pointer;
    color: #6b7280;
  }
  .flipzy-help-title{ margin:0 0 4px; font-size:18px; font-weight:600; color: #111827; }
  .flipzy-help-text{ margin:0 0 16px; font-size:14px; color:#4b5563; line-height: 1.4; }
  
  .flipzy-help-label{ display:block; font-size:13px; font-weight: 500; color: #374151; margin-bottom:12px; }
  .flipzy-help-label input, .flipzy-help-label textarea{
    width:100%; margin-top:6px; padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; font-size:14px; resize:vertical; font-family: inherit;
  }
  .flipzy-help-label input:focus, .flipzy-help-label textarea:focus{ outline: 2px solid #22c55e; border-color: transparent; }
  
  .flipzy-help-submit{
    margin-top:8px; width:100%; padding:12px 14px; border-radius:999px; border:none; background:#22c55e; color:#fff; font-weight:600; cursor:pointer; font-size: 15px; transition: background 0.2s;
  }
  .flipzy-help-submit:hover{ background:#16a34a; }

  @media (max-width:768px){
    .flipzy-help-button{ bottom: 85px; right:16px; } /* Malo nad sticky barom na mobitelu */
    .flipzy-help-modal{ margin:0 16px; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    var openBtn = document.getElementById('flipzy-help-open');
    var overlay = document.getElementById('flipzy-help-overlay');
    var closeBtn = document.getElementById('flipzy-help-close');
    var form = document.getElementById('flipzy-help-form');
    var replyInput = document.querySelector('input[name="contact[reply_email]"]');
    var messageTextarea = document.querySelector('textarea[name="contact[body]"]');

    if(!openBtn || !overlay || !closeBtn) return;

    // --- SCROLL LOGIC (Isto kot Sticky Bar) ---
    var triggerSection = document.querySelector('.flipzy-hero-container') || document.querySelector('.section-featured-product');

    function checkScroll() {
      if (!triggerSection) {
         // Fallback
         if(window.scrollY > 400) openBtn.classList.add('is-visible');
         else openBtn.classList.remove('is-visible');
         return;
      }
      
      var triggerBottom = triggerSection.getBoundingClientRect().bottom;
      
      // Ko gre Hero izven ekrana, pokaži gumb
      if (triggerBottom < 0) {
        openBtn.classList.add('is-visible');
      } else {
        openBtn.classList.remove('is-visible');
      }
    }
    window.addEventListener('scroll', checkScroll, { passive: true });
    checkScroll(); // Preveri takoj

    // --- POPUP LOGIC ---
    function openPopup(){
      overlay.classList.add('is-open');
      overlay.setAttribute('aria-hidden','false');
    }
    function closePopup(){
      overlay.classList.remove('is-open');
      overlay.setAttribute('aria-hidden','true');
    }

    openBtn.addEventListener('click', openPopup);
    closeBtn.addEventListener('click', closePopup);
    overlay.addEventListener('click', function(e){
      if(e.target === overlay) closePopup();
    });

    if (form && replyInput && messageTextarea) {
      form.addEventListener('submit', function () {
        var replyEmail = replyInput.value.trim();
        if (replyEmail) {
          var originalMessage = messageTextarea.value;
          messageTextarea.value = {{ 'sections.flipzy_help.reply_to' | t | json }} + " " + replyEmail + '\n\n----------------------\n' + originalMessage;
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Help Popup (Flipzy)",
  "tag": "section",
  "settings": [],
  "presets": [
    {
      "name": "Help Popup (Flipzy)"
    }
  ]
}
{% endschema %}