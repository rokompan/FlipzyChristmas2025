{% comment %}
  Flipzy – Offer Tiles (block-based)
  - Add up to 8 tiles via Theme Editor blocks.
  - Each tile selects a product and shows image, title, subtitle, price, compare-at, % saved, CTA.
  - Uses Flipzy design tokens defined in flipzy-custom.css (:root variables).
  - NOTE: Shopify schema requires non-blank defaults for text settings.
          We use "_" as a sentinel default and suppress rendering when value == "_".
{% endcomment %}

<section class="flipzy-section flipzy-tiles-section scheme-{{ section.settings.color_scheme }}">
  <div class="flipzy-tiles-container">
    {% if section.settings.heading != blank %}
      <div class="flipzy-tiles-header">
        <h2 class="flipzy-tiles-title">{{ section.settings.heading | escape }}</h2>
        {% if section.settings.subheading != blank %}
          <p class="flipzy-tiles-sub">{{ section.settings.subheading | escape }}</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="flipzy-tiles-grid">
      {% for block in section.blocks %}
        {% assign p = block.settings.product %}
        {% if p != blank %}
          {% assign v = p.selected_or_first_available_variant %}
          {% assign price = v.price %}
          {% assign compare_at = v.compare_at_price %}

          {% assign has_compare = false %}
          {% if compare_at != blank and compare_at > price %}
            {% assign has_compare = true %}
          {% endif %}

          {% assign save_pct = 0 %}
          {% if has_compare %}
            {% assign diff = compare_at | minus: price %}
            {% assign save_pct = diff | times: 100 | divided_by: compare_at | round %}
          {% endif %}

          {%- assign badge_txt = block.settings.badge_text | strip -%}
          {%- assign custom_title = block.settings.custom_title | strip -%}
          {%- assign subtitle = block.settings.subtitle | strip -%}
          {%- assign note_txt = block.settings.note | strip -%}
          {%- assign cta_txt = block.settings.cta_text | strip -%}

          <article class="flipzy-tile{% if block.settings.emphasis %} is-emphasis{% endif %}" {{ block.shopify_attributes }}>
            <a class="flipzy-tile-media" href="{{ p.url }}">
              {% if block.settings.custom_image != blank %}
                {{ block.settings.custom_image | image_url: width: 1200 | image_tag: loading: 'lazy', alt: (custom_title != "_" and custom_title != "" ) | default: false }}
              {% elsif p.featured_image %}
                {{ p.featured_image | image_url: width: 1200 | image_tag: loading: 'lazy', alt: p.title }}
              {% else %}
                <div class="flipzy-tile-media-placeholder"></div>
              {% endif %}

              {% if badge_txt != blank and badge_txt != "_" %}
                <span class="flipzy-tile-badge">{{ badge_txt | escape }}</span>
              {% elsif has_compare and section.settings.auto_badge %}
                <span class="flipzy-tile-badge">Save {{ save_pct }}%</span>
              {% endif %}
            </a>

            <div class="flipzy-tile-body">
              <div class="flipzy-tile-top">
                <h3 class="flipzy-tile-heading">
                  {% if custom_title != blank and custom_title != "_" %}
                    {{ custom_title | escape }}
                  {% else %}
                    {{ p.title | escape }}
                  {% endif %}
                </h3>

                {% if subtitle != blank and subtitle != "_" %}
                  <p class="flipzy-tile-subtitle">{{ subtitle | escape }}</p>
                {% endif %}
              </div>

              <div class="flipzy-tile-price">
                {% if has_compare %}
                  <span class="flipzy-tile-compare">{{ compare_at | money }}</span>
                {% endif %}
                <span class="flipzy-tile-current">{{ price | money }}</span>

                {% if has_compare and section.settings.show_save_pill %}
                  <span class="flipzy-tile-savepill">Save {{ save_pct }}%</span>
                {% endif %}
              </div>

              <div class="flipzy-tile-cta">
                <a class="flipzy-tiles-btn" href="{{ p.url }}">
                  {% if cta_txt != blank %}
                    {{ cta_txt | escape }}
                  {% else %}
                    Shop now
                  {% endif %}
                </a>

                {% if note_txt != blank and note_txt != "_" %}
                  <p class="flipzy-tile-note">{{ note_txt | escape }}</p>
                {% endif %}
              </div>
            </div>
          </article>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <style>
    .flipzy-tiles-section{ padding: 56px 20px; width: 100%; }
    .flipzy-tiles-container{ max-width: 1400px; margin: 0 auto; }

    .flipzy-tiles-section.scheme-white{ background: var(--color-white); color: var(--color-charcoal); }
    .flipzy-tiles-section.scheme-cream{ background: var(--color-cream); color: var(--color-charcoal); }
    .flipzy-tiles-section.scheme-night{ background: var(--color-charcoal); color: var(--color-white); }

    .flipzy-tiles-header{ display:flex; flex-direction:column; gap:10px; margin-bottom:22px; text-align:left; }
    .flipzy-tiles-title{ margin:0; font-size:2.1rem; line-height:1.15; font-weight:700; color:inherit; }
    .flipzy-tiles-sub{ margin:0; opacity:.75; font-size:1.05rem; line-height:1.5; max-width:60ch; }

    .flipzy-tiles-grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media (min-width: 640px){ .flipzy-tiles-grid{ grid-template-columns:repeat(2,1fr); gap:18px; } }
    @media (min-width: 1100px){ .flipzy-tiles-grid{ grid-template-columns:repeat({{ section.settings.columns_desktop }},1fr); gap:20px; } }

    .flipzy-tile{
      background: rgba(255,255,255,.92);
      border-radius: 22px;
      overflow: hidden;
      box-shadow: 0 14px 36px rgba(0,0,0,.08);
      display:flex;
      flex-direction:column;
      min-height:100%;
      border:1px solid rgba(0,0,0,.06);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .scheme-night .flipzy-tile{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    .flipzy-tile:hover{ transform: translateY(-3px); box-shadow: 0 18px 44px rgba(0,0,0,.10); }
    .flipzy-tile.is-emphasis{ border:2px solid var(--color-mustard); box-shadow:0 18px 46px rgba(244,211,94,.25); }

    .flipzy-tile-media{ position:relative; display:block; line-height:0; background:rgba(0,0,0,.03); aspect-ratio: 4 / 3; }
    .flipzy-tile-media img{ width:100%; height:100%; object-fit:cover; display:block; }
    .flipzy-tile-media-placeholder{ width:100%; height:100%; background:rgba(0,0,0,.06); }

    .flipzy-tile-badge{
      position:absolute; top:12px; left:12px;
      background: rgba(0,0,0,.85); color:#fff;
      padding:6px 10px; border-radius:999px;
      font-size:.85rem; font-weight:700; letter-spacing:.2px;
    }

    .flipzy-tile-body{ padding:14px 14px 16px; display:flex; flex-direction:column; gap:12px; flex:1; color:inherit; }
    .flipzy-tile-heading{ margin:0 0 6px 0; font-size:1.2rem; line-height:1.2; font-weight:800; color:inherit; }
    .flipzy-tile-subtitle{ margin:0; opacity:.78; font-size:.95rem; line-height:1.4; }

    .flipzy-tile-price{ display:flex; align-items:baseline; flex-wrap:wrap; gap:10px; margin-top:2px; }
    .flipzy-tile-compare{ text-decoration:line-through; opacity:.55; font-weight:600; }
    .flipzy-tile-current{ font-size:1.6rem; font-weight:900; letter-spacing:-.2px; }
    .flipzy-tile-savepill{ background:#000; color:#fff; padding:4px 10px; border-radius:8px; font-size:.85rem; font-weight:800; }

    .flipzy-tile-cta{ margin-top:auto; display:flex; flex-direction:column; gap:8px; }
    .flipzy-tiles-btn{
      display:inline-flex; align-items:center; justify-content:center; width:100%;
      text-decoration:none;
      background: var(--color-mustard);
      color: var(--color-charcoal);
      border-radius:999px;
      padding:12px 18px;
      font-weight:800;
      font-size:1.05rem;
      border:2px solid var(--color-mustard);
      transition: transform .18s ease;
    }
    .flipzy-tiles-btn:hover{ transform: scale(1.01); }

    .flipzy-tile-note{ margin:0; font-size:.85rem; opacity:.75; line-height:1.35; }
  </style>
</section>

{% schema %}
{
  "name": "Flipzy – Offer Tiles",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Choose your bundle" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Save more when you get a pack — perfect for families and routines." },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "cream",
      "options": [
        { "value": "white", "label": "White" },
        { "value": "cream", "label": "Cream" },
        { "value": "night", "label": "Night" }
      ]
    },
    { "type": "range", "id": "columns_desktop", "label": "Columns on desktop", "min": 2, "max": 4, "step": 1, "default": 4 },
    { "type": "checkbox", "id": "show_save_pill", "label": "Show Save % pill", "default": true },
    { "type": "checkbox", "id": "auto_badge", "label": "Auto badge with Save % if no custom badge text is set", "default": false }
  ],
  "blocks": [
    {
      "type": "tile",
      "name": "Offer tile",
      "settings": [
        { "type": "product", "id": "product", "label": "Product" },
        { "type": "image_picker", "id": "custom_image", "label": "Custom image (optional)" },

        { "type": "text", "id": "badge_text", "label": "Badge text (optional)", "default": "_" },
        { "type": "text", "id": "custom_title", "label": "Custom title (optional)", "default": "_" },
        { "type": "text", "id": "subtitle", "label": "Subtitle (optional)", "default": "_" },

        { "type": "text", "id": "cta_text", "label": "Button text", "default": "Shop now" },

        { "type": "text", "id": "note", "label": "Small note under button (optional)", "default": "_" },

        { "type": "checkbox", "id": "emphasis", "label": "Emphasize this tile", "default": false }
      ]
    }
  ],
  "max_blocks": 8,
  "presets": [
    {
      "name": "Flipzy – Offer Tiles",
      "blocks": [
        { "type": "tile" },
        { "type": "tile" },
        { "type": "tile" },
        { "type": "tile" }
      ]
    }
  ]
}
{% endschema %}
