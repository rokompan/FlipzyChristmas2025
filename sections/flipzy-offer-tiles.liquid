{%- liquid
  assign padding_top = section.settings.padding_top
  assign padding_bottom = section.settings.padding_bottom
-%}

{{ 'component-rating.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ padding_bottom | times: 0.75 | round: 0 }}px;
    /* Darker background to make tiles pop */
    background-color: #f4f4f5; 
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ padding_top }}px;
      padding-bottom: {{ padding_bottom }}px;
    }
  }

  /* --- FLIPZY TILE CONTAINER --- */
  .flipzy-tiles-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px; 
    width: 100%;
    margin-top: 1.5rem;
  }

  @media screen and (min-width: 990px) {
    .flipzy-tiles-grid {
      grid-template-columns: repeat({{ section.blocks.size | at_most: 4 }}, 1fr);
      gap: 20px;
      align-items: stretch; 
    }
  }

  /* --- INDIVIDUAL TILE CARD --- */
  .flipzy-tile {
    position: relative;
    background: #ffffff; /* Ensure tile is pure white */
    border: 1px solid rgba(0,0,0, 0.05);
    border-radius: 20px; 
    padding: 24px 18px 18px 18px; /* Extra top padding for badges */
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    height: 100%;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  .flipzy-tile:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  }

  /* Highlighted Tile (Best Value) */
  .flipzy-tile.is-highlighted {
    border: 2px solid #F4D35E;
    background: #FFFBEB; 
  }

  /* --- TOP CENTER BADGE (Best Value) --- */
  .flipzy-tile-badge {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: #000;
    color: #fff;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 1.1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    z-index: 3;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  .flipzy-tile.is-highlighted .flipzy-tile-badge {
    background: #D97706; 
  }

  /* --- IMAGE --- */
  .flipzy-tile-media {
    width: 100%;
    /* Mobile: Landscape (3:2) to make it shorter */
    aspect-ratio: 3 / 2; 
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 15px;
    position: relative;
    z-index: 1; /* Behind sticker */
  }
  
  .flipzy-tile-media img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Ensures image covers area without stretch */
    transition: scale 0.3s ease;
  }

  .flipzy-tile:hover .flipzy-tile-media img {
    scale: 1.05;
  }

  /* --- STICKER TAG (Pack Count) --- */
  .flipzy-pack-sticker {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #111;
    color: #fff;
    padding: 6px 12px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1;
    z-index: 5; /* Above image */
    box-shadow: 2px 4px 10px rgba(0,0,0,0.25);
    transform: rotate(3deg); /* Sticker look */
    border: 2px solid #fff;
  }

  .flipzy-pack-sticker .sticker-big {
    font-size: 1.6rem;
    font-weight: 800;
    display: block;
    margin-bottom: 2px;
  }
  
  .flipzy-pack-sticker .sticker-small {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.9;
  }

  /* --- CONTENT --- */
  .flipzy-tile-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    text-align: center;
  }

  .flipzy-tile-title {
    font-size: 1.6rem; 
    font-weight: 700;
    margin: 0 0 10px 0;
    line-height: 1.3;
    color: rgb(var(--color-foreground));
  }

  .flipzy-tile-desc {
    font-size: 1.4rem;
    opacity: 0.8;
    margin-bottom: 15px;
    line-height: 1.5;
  }

  /* --- PRICING --- */
  .flipzy-tile-price-wrapper {
    margin-top: auto; 
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    margin-bottom: 15px;
  }

  .flipzy-price-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .flipzy-price-current {
    font-size: 1.8rem;
    font-weight: 800;
    color: rgb(var(--color-foreground));
  }

  .flipzy-price-compare {
    text-decoration: line-through;
    opacity: 0.6;
    font-size: 1.3rem; 
  }

  .flipzy-save-pill {
    background-color: #EF4444; 
    color: #fff;
    font-size: 1.1rem; 
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 6px;
    display: inline-block;
  }

  .flipzy-shipping-badge {
    color: #059669; 
    background: #ECFDF5; 
    border: 1px solid #6EE7B7;
    font-size: 1rem; 
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 6px;
    display: inline-block;
    text-transform: uppercase;
    margin-top: 4px;
  }

  /* --- BUTTON --- */
  .flipzy-tile-submit {
      background-color: #F4D35E !important;
      color: #111827 !important;
      border: none !important;
      border-radius: 50px !important;
      font-weight: 700 !important;
      font-size: 1.5rem !important; 
      text-transform: none !important;
      padding: 14px 20px !important;
      box-shadow: 0 4px 15px rgba(244, 211, 94, 0.4) !important;
      width: 100%;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin-top: 5px;
  }
  
  .flipzy-tile-submit:hover { transform: scale(1.02); }

  /* Desktop Adjustments */
  @media screen and (min-width: 990px) {
    /* Restore Square Image on Desktop */
    .flipzy-tile-media { aspect-ratio: 1 / 1; }
    
    .flipzy-tile-title { font-size: 1.4rem; }
    .flipzy-tile-desc { font-size: 1rem; }
    .flipzy-price-current { font-size: 1.6rem; }
    .flipzy-tile-submit { font-size: 1.2rem !important; padding: 12px 15px !important; }
    .flipzy-tile-badge { font-size: 0.8rem; padding: 5px 15px; }
    .flipzy-save-pill { font-size: 0.85rem; }
    .flipzy-shipping-badge { font-size: 0.8rem; }
  }
  
  /* Pulse Animation Logic */
  .flipzy-pulse-anim::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 50px;
      box-shadow: 0 0 0 0 rgba(244, 211, 94, 0.7);
      animation: flipzy-pulse 2s infinite;
      z-index: 1;
      pointer-events: none;
  }

  @keyframes flipzy-pulse {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 211, 94, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(244, 211, 94, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 211, 94, 0); }
  }

{%- endstyle -%}

<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

<div class="section-{{ section.id }}-padding">
  <div class="page-width">
    
    {%- if section.settings.title != blank -%}
      <div class="title-wrapper title-wrapper--no-top-margin center">
        <h2 class="title {{ section.settings.heading_size }}">{{ section.settings.title }}</h2>
        {%- if section.settings.text != blank -%}
            <div class="rte" style="font-size: 1.5rem;">{{ section.settings.text }}</div>
        {%- endif -%}
      </div>
    {%- endif -%}

    <div class="flipzy-tiles-grid">
      {%- for block in section.blocks -%}
        {%- assign product = block.settings.product -%}
        {%- assign highlight = block.settings.highlight_tile -%}
        
        <div class="flipzy-tile {% if highlight %}is-highlighted{% endif %}" {{ block.shopify_attributes }}>
          
          {%- if block.settings.badge_text != blank -%}
            <div class="flipzy-tile-badge">{{ block.settings.badge_text }}</div>
          {%- endif -%}

          {% comment %} 
            --- BUNDLE COUNT LOGIC ---
          {% endcomment %}
          {%- liquid
            assign bundle_count = 1
            if block.settings.manual_bundle_size != blank
               assign bundle_count = block.settings.manual_bundle_size
            elsif product.title contains '4-Pack'
               assign bundle_count = 4
            elsif product.title contains '3-Pack'
               assign bundle_count = 3
            elsif product.title contains '2-Pack'
               assign bundle_count = 2
            endif
          -%}
          
          <div class="flipzy-pack-sticker">
            <span class="sticker-big">{{ bundle_count }}x</span>
            <span class="sticker-small">Flipzy</span>
          </div>

          <div class="flipzy-tile-media">
            {%- if product.featured_image != blank -%}
              <img
                src="{{ product.featured_image | image_url: width: 600 }}"
                alt="{{ product.title | escape }}"
                loading="lazy"
                width="{{ product.featured_image.width }}"
                height="{{ product.featured_image.height }}"
              >
            {%- else -%}
              {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
            {%- endif -%}
          </div>

          <div class="flipzy-tile-content">
            <h3 class="flipzy-tile-title">
              {%- if block.settings.custom_title != blank -%}
                {{ block.settings.custom_title }}
              {%- else -%}
                {{ product.title }}
              {%- endif -%}
            </h3>

            {%- if block.settings.description != blank -%}
              <div class="flipzy-tile-desc">{{ block.settings.description }}</div>
            {%- endif -%}

            <div class="flipzy-tile-price-wrapper">
              <div class="flipzy-price-container">
                <span class="flipzy-price-current">
                   {{ product.price | money }}
                </span>
                {%- if product.compare_at_price > product.price -%}
                  <span class="flipzy-price-compare">{{ product.compare_at_price | money }}</span>
                {%- endif -%}
              </div>

              {%- if product.compare_at_price > product.price -%}
                {%- assign saved = product.compare_at_price | minus: product.price -%}
                {%- assign pct = saved | times: 100.0 | divided_by: product.compare_at_price -%}
                {%- assign pct_rounded = pct | round -%}
                <div class="flipzy-save-pill">
                  Save {{ pct_rounded }}%
                </div>
              {%- endif -%}

              {%- if block.settings.show_shipping_badge -%}
                 <div class="flipzy-shipping-badge">FREE SHIPPING</div>
              {%- endif -%}

            </div>

            <product-form class="product-form">
              {%- form 'product', product, id: product_form_id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                <button
                  type="submit"
                  name="add"
                  class="flipzy-tile-submit {% if highlight %}flipzy-pulse-anim{% endif %}"
                  {% if product.selected_or_first_available_variant.available == false %}disabled{% endif %}
                >
                  <span>
                    {%- if product.selected_or_first_available_variant.available -%}
                      {{ block.settings.button_text }}
                    {%- else -%}
                      Sold Out
                    {%- endif -%}
                  </span>
                  <div class="loading__spinner hidden">
                    <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </div>
                </button>
              {%- endform -%}
            </product-form>

          </div>
        </div>
      {%- endfor -%}
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Flipzy Offer Tiles",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "default": "Choose Your Bundle",
      "label": "Heading"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        { "value": "h2", "label": "Small" },
        { "value": "h1", "label": "Medium" },
        { "value": "h0", "label": "Large" }
      ],
      "default": "h1",
      "label": "Heading Size"
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "Description",
      "default": "<p>Select the package that fits your family best.</p>"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top Padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom Padding",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "tile",
      "name": "Offer Tile",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Bundle Product"
        },
        {
          "type": "checkbox",
          "id": "highlight_tile",
          "label": "Highlight this tile?",
          "default": false,
          "info": "Adds a border and pulse animation to the button."
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Top Badge Text",
          "default": "MOST POPULAR",
          "info": "Leave empty to hide."
        },
        {
          "type": "text",
          "id": "manual_bundle_size",
          "label": "Bundle Size (Override)",
          "info": "Enter number of items (e.g., 4). Leave blank to auto-detect from title (looks for '4-Pack')."
        },
        {
          "type": "text",
          "id": "custom_title",
          "label": "Custom Title Override",
          "info": "Optional. Replaces product title."
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Short Description",
          "default": "Perfect for small families."
        },
        {
          "type": "checkbox",
          "id": "show_shipping_badge",
          "label": "Show 'Free Shipping' Badge",
          "default": false
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button Text",
          "default": "Add to Cart"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Flipzy Offer Tiles",
      "blocks": [
        {
          "type": "tile"
        },
        {
          "type": "tile",
          "settings": {
            "highlight_tile": true,
            "badge_text": "BEST VALUE",
            "show_shipping_badge": true
          }
        },
        {
          "type": "tile"
        }
      ]
    }
  ]
}
{% endschema %}