{%- liquid
  assign padding_top = section.settings.padding_top
  assign padding_bottom = section.settings.padding_bottom
-%}

{{ 'component-rating.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ padding_top }}px;
      padding-bottom: {{ padding_bottom }}px;
    }
  }

  /* --- FLIPZY TILE CONTAINER --- */
  .flipzy-tiles-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    width: 100%;
    margin-top: 2rem;
  }

  @media screen and (min-width: 990px) {
    .flipzy-tiles-grid {
      /* Dynamic columns based on block count, max 3 */
      grid-template-columns: repeat({{ section.blocks.size | at_most: 3 }}, 1fr);
      gap: 30px;
      align-items: stretch; /* Make cards same height */
    }
  }

  /* --- INDIVIDUAL TILE CARD --- */
  .flipzy-tile {
    position: relative;
    background: rgb(var(--color-background));
    border: 1px solid rgba(var(--color-foreground), 0.1);
    border-radius: 20px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    height: 100%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
  }

  .flipzy-tile:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  /* Highlighted Tile (Best Value) */
  .flipzy-tile.is-highlighted {
    border: 2px solid #F4D35E;
    background: #FFFBEB; /* Light yellow tint */
  }

  /* --- TILE HEADER --- */
  .flipzy-tile-badge {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background: #000;
    color: #fff;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    z-index: 2;
  }
  
  .flipzy-tile.is-highlighted .flipzy-tile-badge {
    background: #D97706; /* Darker yellow/orange for contrast */
  }

  /* --- IMAGE --- */
  .flipzy-tile-media {
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 15px;
    aspect-ratio: 1 / 1;
    position: relative;
  }
  
  .flipzy-tile-media img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: scale 0.3s ease;
  }

  .flipzy-tile:hover .flipzy-tile-media img {
    scale: 1.05;
  }

  /* --- CONTENT --- */
  .flipzy-tile-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    text-align: center;
  }

  .flipzy-tile-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0 0 10px 0;
    line-height: 1.3;
    color: rgb(var(--color-foreground));
  }

  .flipzy-tile-desc {
    font-size: 0.95rem;
    opacity: 0.8;
    margin-bottom: 15px;
    line-height: 1.4;
  }

  /* --- PRICING --- */
  .flipzy-tile-price-wrapper {
    margin-top: auto; /* Pushes to bottom of content area */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    margin-bottom: 15px;
  }

  .flipzy-price-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .flipzy-price-current {
    font-size: 1.5rem;
    font-weight: 800;
    color: rgb(var(--color-foreground));
  }

  .flipzy-price-compare {
    text-decoration: line-through;
    opacity: 0.6;
    font-size: 1rem;
  }

  .flipzy-save-pill {
    background-color: #EF4444; /* Red for savings */
    color: #fff;
    font-size: 0.8rem;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 4px;
    display: inline-block;
  }

  /* --- BUTTON (Stolen from your strip section) --- */
  .flipzy-tile-submit {
      background-color: #F4D35E !important;
      color: #111827 !important;
      border: none !important;
      border-radius: 50px !important;
      font-weight: 700 !important;
      font-size: 1.1rem !important;
      text-transform: none !important;
      padding: 12px 20px !important;
      box-shadow: 0 4px 15px rgba(244, 211, 94, 0.4) !important;
      width: 100%;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin-top: 10px;
  }
  
  .flipzy-tile-submit:hover { transform: scale(1.02); }
  
  /* Pulse Animation Logic  */
  .flipzy-pulse-anim::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 50px;
      box-shadow: 0 0 0 0 rgba(244, 211, 94, 0.7);
      animation: flipzy-pulse 2s infinite;
      z-index: 1;
      pointer-events: none;
  }

  @keyframes flipzy-pulse {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 211, 94, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(244, 211, 94, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 211, 94, 0); }
  }

{%- endstyle -%}

<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

<div class="color-{{ section.settings.color_scheme }} gradient section-{{ section.id }}-padding">
  <div class="page-width">
    
    {%- if section.settings.title != blank -%}
      <div class="title-wrapper title-wrapper--no-top-margin center">
        <h2 class="title {{ section.settings.heading_size }}">{{ section.settings.title }}</h2>
        {%- if section.settings.text != blank -%}
            <div class="rte">{{ section.settings.text }}</div>
        {%- endif -%}
      </div>
    {%- endif -%}

    <div class="flipzy-tiles-grid">
      {%- for block in section.blocks -%}
        {%- assign product = block.settings.product -%}
        {%- assign highlight = block.settings.highlight_tile -%}
        
        <div class="flipzy-tile {% if highlight %}is-highlighted{% endif %}" {{ block.shopify_attributes }}>
          
          {%- if block.settings.badge_text != blank -%}
            <div class="flipzy-tile-badge">{{ block.settings.badge_text }}</div>
          {%- endif -%}

          <div class="flipzy-tile-media">
            {%- if product.featured_image != blank -%}
              <img
                src="{{ product.featured_image | image_url: width: 600 }}"
                alt="{{ product.title | escape }}"
                loading="lazy"
                width="{{ product.featured_image.width }}"
                height="{{ product.featured_image.height }}"
              >
            {%- else -%}
              {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
            {%- endif -%}
          </div>

          <div class="flipzy-tile-content">
            <h3 class="flipzy-tile-title">
              {%- if block.settings.custom_title != blank -%}
                {{ block.settings.custom_title }}
              {%- else -%}
                {{ product.title }}
              {%- endif -%}
            </h3>

            {%- if block.settings.description != blank -%}
              <div class="flipzy-tile-desc">{{ block.settings.description }}</div>
            {%- endif -%}

            <div class="flipzy-tile-price-wrapper">
              <div class="flipzy-price-container">
                <span class="flipzy-price-current">
                   {{ product.price | money }}
                </span>
                {%- if product.compare_at_price > product.price -%}
                  <span class="flipzy-price-compare">{{ product.compare_at_price | money }}</span>
                {%- endif -%}
              </div>

              {%- if product.compare_at_price > product.price -%}
                {%- assign saved = product.compare_at_price | minus: product.price -%}
                {%- assign pct = saved | times: 100.0 | divided_by: product.compare_at_price -%}
                {%- assign pct_rounded = pct | round -%}
                <div class="flipzy-save-pill">
                  Save {{ pct_rounded }}%
                </div>
              {%- endif -%}
            </div>

            <product-form class="product-form">
              {%- form 'product', product, id: product_form_id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                <button
                  type="submit"
                  name="add"
                  class="flipzy-tile-submit {% if highlight %}flipzy-pulse-anim{% endif %}"
                  {% if product.selected_or_first_available_variant.available == false %}disabled{% endif %}
                >
                  <span>
                    {%- if product.selected_or_first_available_variant.available -%}
                      {{ block.settings.button_text }}
                    {%- else -%}
                      Sold Out
                    {%- endif -%}
                  </span>
                  <div class="loading__spinner hidden">
                    <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </div>
                </button>
              {%- endform -%}
            </product-form>

          </div>
        </div>
      {%- endfor -%}
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Flipzy Offer Tiles",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "default": "Choose Your Bundle",
      "label": "Heading"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        { "value": "h2", "label": "Small" },
        { "value": "h1", "label": "Medium" },
        { "value": "h0", "label": "Large" }
      ],
      "default": "h1",
      "label": "Heading Size"
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "Description",
      "default": "<p>Select the package that fits your family best.</p>"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top Padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom Padding",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "tile",
      "name": "Offer Tile",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Bundle Product"
        },
        {
          "type": "checkbox",
          "id": "highlight_tile",
          "label": "Highlight this tile?",
          "default": false,
          "info": "Adds a border and pulse animation to the button."
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Top Badge Text",
          "default": "MOST POPULAR",
          "info": "Leave empty to hide."
        },
        {
          "type": "text",
          "id": "custom_title",
          "label": "Custom Title Override",
          "info": "Optional. Replaces product title."
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Short Description",
          "default": "Perfect for small families."
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button Text",
          "default": "Add to Cart"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Flipzy Offer Tiles",
      "blocks": [
        {
          "type": "tile"
        },
        {
          "type": "tile",
          "settings": {
            "highlight_tile": true,
            "badge_text": "BEST VALUE"
          }
        },
        {
          "type": "tile"
        }
      ]
    }
  ]
}
{% endschema %}