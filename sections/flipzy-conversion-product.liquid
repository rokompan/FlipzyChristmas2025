{% schema %}
{
  "name": "Flipzy Conversion Product",
  "class": "flipzy-section",
  "settings": [
    { "type": "header", "content": "Product" },
    { "type": "product", "id": "product", "label": "Select Product" },
    { "type": "header", "content": "Offer Content" },
    { "type": "text", "id": "badge", "label": "Top Badge", "default": "SPECIAL OFFER – WHILE SUPPLIES LAST" },
    { "type": "text", "id": "heading", "label": "Custom Heading", "default": "Kids Routine Board That Works" },
    { "type": "richtext", "id": "description", "label": "Short Description", "default": "<p>Don't miss this exclusive opportunity to transform your family's daily routines. Order now and save!</p>" },
    { "type": "header", "content": "Urgency & Trust" },
    { "type": "checkbox", "id": "show_stock", "label": "Show Low Stock Indicator", "default": true },
    { "type": "text", "id": "stock_text", "label": "Stock Text", "default": "Low stock - selling fast" },
    { "type": "text", "id": "shipping_text", "label": "Shipping Text", "default": "Ships within 24h • Free Shipping over €50" },
    { "type": "text", "id": "guarantee_text", "label": "Guarantee Text", "default": "30-day money-back guarantee • 24 months warranty" },
    { "type": "text", "id": "button_text", "label": "Button Text", "default": "Add to Cart" },
    { "type": "checkbox", "id": "show_dynamic_checkout", "label": "Show Dynamic Checkout (PayPal)", "default": false }
  ],
  "presets": [ { "name": "Flipzy Conversion Product" } ]
}
{% endschema %}

{%- liquid
  assign product = section.settings.product
  assign variant = product.selected_or_first_available_variant
  assign compare_price = variant.compare_at_price
  assign price = variant.price
  assign title = section.settings.heading | default: product.title
  
  if compare_price > price
    assign saved_amount = compare_price | minus: price
    assign raw_pct = saved_amount | times: 100.0 | divided_by: compare_price
    # Round to nearest 5 (e.g. 41 -> 40, 43 -> 45)
    assign saved_pct = raw_pct | divided_by: 5 | round | times: 5
  endif
-%}

<div class="flipzy-super-section">
  <div class="flipzy-super-wrapper">
    
    <div class="flipzy-super-media">
      {% if product.featured_image != blank %}
        <img src="{{ product.featured_image | image_url: width: 1200 }}" 
             alt="{{ product.title | escape }}" 
             class="flipzy-super-img"
             loading="lazy">
      {% else %}
        {{ 'product-1' | placeholder_svg_tag: 'flipzy-super-img' }}
      {% endif %}
    </div>

    <div class="flipzy-super-content">
      
      {% if section.settings.badge != blank %}
        <div class="flipzy-badge-center-wrapper">
          <div class="flipzy-super-badge">{{ section.settings.badge }}</div>
        </div>
      {% endif %}
      
      <h2 class="flipzy-super-title">{{ title }}</h2>
      
      <div class="flipzy-super-price-row">
        {% if product != blank %}
          {% if compare_price > price %}
            <span class="flipzy-super-price-old">{{ compare_price | money }}</span>
          {% endif %}
          
          <span class="flipzy-super-price-new">{{ price | money }}</span>
          
          {% if compare_price > price %}
            <span class="flipzy-super-price-save-badge">Save {{ saved_pct }}%</span>
          {% endif %}
        {% else %}
          <span class="flipzy-super-price-old">€49,00</span>
          <span class="flipzy-super-price-new">€29,00</span>
          <span class="flipzy-super-price-save-badge">Save 40%</span>
        {% endif %}
      </div>

      <div class="flipzy-super-meta">
        {% if section.settings.show_stock %}
          <div class="flipzy-meta-row" style="color: #EF4444;">
            <span class="pulsing-dot"></span>
            {{ section.settings.stock_text }}
          </div>
        {% endif %}
        
        <div class="flipzy-meta-row">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
          {{ section.settings.shipping_text }}
        </div>
      </div>

      <div class="flipzy-super-desc">
        {{ section.settings.description }}
      </div>

      {% if product != blank %}
        <div style="width: 100%;">
          <button 
            type="button" 
            onclick="addFlipzyToCart(this, '{{ variant.id }}')"
            class="flipzy-offer-btn" 
            {% unless variant.available %}disabled style="opacity: 0.6; cursor: not-allowed;"{% endunless %}
          >
            <span class="btn-text">
              {% if variant.available %}
                {{ section.settings.button_text }} - {{ price | money }}
              {% else %}
                Sold Out
              {% endif %}
            </span>
            <div class="loading-overlay__spinner hidden" style="position: absolute;">
              <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;"><circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30" stroke="currentColor"></circle></svg>
            </div>
          </button>

          {% if section.settings.show_dynamic_checkout %}
            <div class="flipzy-dynamic-checkout">
              {% form 'product', product %}
                <input type="hidden" name="id" value="{{ variant.id }}">
                {{ form | payment_button }}
              {% endform %}
            </div>
          {% endif %}
        </div>
      {% else %}
        <button class="flipzy-offer-btn">Add to Cart - €29,00</button>
      {% endif %}

      <div class="flipzy-super-guarantee">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        {{ section.settings.guarantee_text }}
      </div>

      <div class="flipzy-super-footer">
        <div class="flipzy-trust-item"><svg class="flipzy-trust-icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg><span>Secure Payment</span></div>
        <div class="flipzy-trust-item"><svg class="flipzy-trust-icon" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg><span>SSL Encrypted</span></div>
        <div class="flipzy-trust-item"><svg class="flipzy-trust-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg><span>Privacy Protected</span></div>
      </div>

    </div>
  </div>
</div>

<script>
  function addFlipzyToCart(btn, variantId) {
    if(!variantId) return;
    
    // 1. Show Spinner
    const spinner = btn.querySelector('.loading-overlay__spinner');
    const text = btn.querySelector('.btn-text');
    if(spinner) spinner.classList.remove('hidden');
    if(text) text.style.opacity = '0';
    
    // 2. AJAX Add
    const formData = {
      'items': [{
        'id': variantId,
        'quantity': 1
      }]
    };

    fetch(window.Shopify.routes.root + 'cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
    .then(response => {
      return response.json();
    })
    .then(data => {
      // 3. Update Cart Bubble (Optional, but nice)
      // fetch('/cart.js').then(...) - Dawn usually handles this via event but let's force open.
      
      // 4. OPEN DRAWER (The "Nuclear" Option)
      const cartDrawer = document.querySelector('cart-drawer');
      const cartNotification = document.querySelector('cart-notification');
      
      if (cartDrawer) {
        // Force Dawn to re-render cart contents
        // We dispatch a bubbling event that Dawn listens to
        document.dispatchEvent(new CustomEvent('cart:build')); // Some themes use this
        
        // Dawn specific: We need to tell the cart-drawer to render. 
        // The safest way in Dawn is to fetch the cart HTML section.
        fetch(`${window.Shopify.routes.root}?sections=cart-drawer`)
          .then(res => res.json())
          .then(sections => {
             cartDrawer.renderContents(sections['cart-drawer']);
             cartDrawer.open();
          });
      } else if (cartNotification) {
         cartNotification.renderContents(data); // If notification is used instead of drawer
         cartNotification.open();
      } else {
         // Fallback if no drawer exists
         window.location.href = '/cart';
      }
    })
    .catch((error) => {
      console.error('Error:', error);
    })
    .finally(() => {
      // Reset Button
      if(spinner) spinner.classList.add('hidden');
      if(text) text.style.opacity = '1';
    });
  }
</script>